{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Scan: {{ assignment['audit_name'] }} / {{ assignment['outlet'] }} / {{ assignment['department'] }}</h4>
  <a class="btn btn-outline-primary" href="{{ url_for('sub_assignments') }}">Back</a>
</div>
{% if not assignment['is_frozen'] and assignment['status'] != 'ended' %}
<div class="card p-3 mb-3">
  <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
    <button id="startCameraBtn" type="button" class="btn btn-outline-primary btn-sm">Start Camera Scanner</button>
    <button id="stopCameraBtn" type="button" class="btn btn-outline-secondary btn-sm" disabled>Stop</button>
    <span id="scannerStatus" class="small-muted">Camera scanner is off.</span>
  </div>
  <div id="zoomWrap" class="mb-2" style="max-width: 420px; display: none;">
    <label for="zoomSlider" class="form-label mb-1">Zoom</label>
    <input id="zoomSlider" type="range" class="form-range" min="1" max="3" step="0.1" value="1">
  </div>
  <div id="scannerBox" class="border rounded"></div>
  <div class="small-muted mt-2">Auto mode: each detection saves +1. Manual mode: fill textbox and edit qty. Tap scanner area to help camera focus.</div>
</div>
{% endif %}
<div class="card p-3 mb-3">
  <form id="scanForm" method="post" class="row g-2">
    <div class="col-md-5">
      <input id="barcodeInput" class="form-control" name="barcode" placeholder="Scan or enter barcode" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %} required>
    </div>
    <div class="col-md-2">
      <input id="qtyInput" class="form-control" type="number" min="1" name="qty" value="1" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>
    </div>
    <div class="col-md-2 d-flex align-items-center">
      <input id="manualMode" type="checkbox" class="form-check-input me-2" name="manual_entry" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>
      <label class="form-check-label">Manual Mode</label>
    </div>
    <div class="col-md-3">
      <button class="btn btn-success w-100" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>Save Scan</button>
    </div>
  </form>
</div>
<div class="card p-3 mb-3">
  <form method="post" action="{{ url_for('sub_freeze', assignment_id=assignment['id']) }}">
    <button class="btn btn-warning" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>Freeze Department Audit</button>
  </form>
  <div class="small-muted mt-2">Once frozen, only admin can unfreeze.</div>
</div>
<div class="card p-3">
  <table class="table table-sm">
    <thead><tr><th>Barcode</th><th>Article</th><th>Scanned</th></tr></thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r['barcode'] }}</td>
        <td>{{ r['article_name'] }}</td>
        <td>{{ r['scanned_qty'] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% if not assignment['is_frozen'] and assignment['status'] != 'ended' %}
<style>
  #scannerBox {
    width: min(100%, 540px);
    aspect-ratio: 3 / 1;
    overflow: hidden;
    position: relative;
    background: #111;
  }
  #focusDot {
    position: absolute;
    width: 44px;
    height: 44px;
    border: 2px solid #00d26a;
    border-radius: 50%;
    pointer-events: none;
    display: none;
    z-index: 20;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 10px rgba(0, 210, 106, 0.6);
  }
  #scannerBox video,
  #scannerBox canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
    border-radius: 8px;
  }
  #scannerBox__scan_region,
  #scannerBox__scan_region img {
    display: none !important;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
  (() => {
    const scanForm = document.getElementById("scanForm");
    const barcodeInput = document.getElementById("barcodeInput");
    const qtyInput = document.getElementById("qtyInput");
    const manualMode = document.getElementById("manualMode");
    const startBtn = document.getElementById("startCameraBtn");
    const stopBtn = document.getElementById("stopCameraBtn");
    const statusEl = document.getElementById("scannerStatus");
    const zoomWrap = document.getElementById("zoomWrap");
    const zoomSlider = document.getElementById("zoomSlider");
    const scannerId = "scannerBox";
    const feedbackUrl = "{{ url_for('sub_scanner_feedback', assignment_id=assignment['id']) }}";

    let scanner = null;
    let isRunning = false;
    let lastScanned = "";
    let lastScannedAt = 0;
    let scanCooldownUntil = 0;
    let submitInFlight = false;
    let noDetectTimer = null;
    let activeTrack = null;
    let zoomSupported = false;
    let pageHeartbeatTimer = null;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function resetZoomUi() {
      zoomWrap.style.display = "none";
      zoomSlider.value = "1";
      activeTrack = null;
      zoomSupported = false;
    }

    async function trySetupZoom() {
      const videoEl = document.querySelector("#scannerBox video");
      if (!videoEl || !videoEl.srcObject) return;
      const tracks = videoEl.srcObject.getVideoTracks();
      if (!tracks || tracks.length === 0) return;
      const track = tracks[0];
      const caps = (typeof track.getCapabilities === "function") ? track.getCapabilities() : {};
      if (!caps || typeof caps.zoom === "undefined") return;

      const settings = (typeof track.getSettings === "function") ? track.getSettings() : {};
      const min = Number(caps.zoom.min || 1);
      const max = Number(caps.zoom.max || 3);
      const step = Number(caps.zoom.step || 0.1);
      const current = Number(settings.zoom || min);
      const target = min + (max - min) * 0.25;
      const snapped = Math.max(min, Math.min(max, Math.round(target / step) * step));

      activeTrack = track;
      zoomSupported = true;
      zoomSlider.min = String(min);
      zoomSlider.max = String(max);
      zoomSlider.step = String(step);
      zoomSlider.value = String(snapped);
      zoomWrap.style.display = "block";
      sendFeedback("zoom_available", "camera-zoom-supported", { min, max, step, current, default_zoom: snapped });
      await applyZoom(snapped);
    }

    async function applyZoom(value) {
      if (!zoomSupported || !activeTrack) return;
      try {
        await activeTrack.applyConstraints({ advanced: [{ zoom: Number(value) }] });
      } catch (err) {}
    }

    async function sendFeedback(event, message = "", details = {}, includeSnapshot = false) {
      const payload = { event, message, details };
      if (includeSnapshot) {
        const snap = captureSnapshot();
        if (snap) payload.snapshot = snap;
      }
      try {
        await fetch(feedbackUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (err) {}
    }

    function sendFeedbackBeacon(event, message = "", details = {}) {
      const payload = { event, message, details };
      try {
        const blob = new Blob([JSON.stringify(payload)], { type: "application/json" });
        navigator.sendBeacon(feedbackUrl, blob);
      } catch (err) {}
    }

    function captureSnapshot() {
      const video = document.querySelector("#scannerBox video");
      if (!video || !video.videoWidth || !video.videoHeight) return null;
      const cw = 320;
      const ch = 180;
      const canvas = document.createElement("canvas");
      canvas.width = cw;
      canvas.height = ch;
      const ctx = canvas.getContext("2d");
      try {
        ctx.drawImage(video, 0, 0, cw, ch);
        return canvas.toDataURL("image/jpeg", 0.6);
      } catch (err) {
        return null;
      }
    }

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 1000;
        gain.gain.value = 0.05;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(() => { osc.stop(); ctx.close(); }, 80);
      } catch (err) {}
      if (navigator.vibrate) navigator.vibrate(80);
    }

    function updateScannedCountInTable(barcode, delta) {
      const rows = document.querySelectorAll("table tbody tr");
      rows.forEach((row) => {
        const tds = row.querySelectorAll("td");
        if (tds.length < 3) return;
        const code = (tds[0].textContent || "").trim();
        if (code === barcode) {
          const current = parseInt((tds[2].textContent || "0").trim(), 10) || 0;
          tds[2].textContent = String(current + delta);
        }
      });
    }

    async function submitAutoScan(barcode) {
      if (submitInFlight) return;
      submitInFlight = true;
      try {
        const body = new URLSearchParams();
        body.set("barcode", barcode);
        body.set("qty", "1");
        const resp = await fetch(window.location.pathname, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body.toString()
        });
        if (!resp.ok) {
          setStatus("Auto scan failed. Check barcode list.");
          return;
        }
        beep();
        updateScannedCountInTable(barcode, 1);
        setStatus(`Scanned ${barcode} (+1)`);
      } catch (err) {
        setStatus("Auto scan failed. Network/server error.");
      } finally {
        submitInFlight = false;
      }
    }

    function applyModeState() {
      if (manualMode.checked) {
        qtyInput.disabled = false;
        setStatus("Manual mode on. Scanner fills textbox.");
      } else {
        qtyInput.value = "1";
        qtyInput.disabled = true;
        setStatus("Auto mode on. Each scan saves +1.");
      }
    }

    function handleDetected(decodedText) {
      const text = (decodedText || "").trim();
      const now = Date.now();
      if (!text) return;
      if (now < scanCooldownUntil) return;
      if (text === lastScanned && now - lastScannedAt < 2000) return;
      lastScanned = text;
      lastScannedAt = now;
      scanCooldownUntil = now + 1000;

      if (manualMode.checked) {
        barcodeInput.value = text;
        beep();
        setStatus("Barcode captured (manual). Edit qty and Save.");
        barcodeInput.focus();
        sendFeedback("detected_manual", "barcode-detected", { barcode: text, mode: "manual" });
      } else {
        sendFeedback("detected_auto", "barcode-detected", { barcode: text, mode: "auto" });
        submitAutoScan(text);
      }
      setTimeout(() => {
        lastScanned = "";
      }, 1000);
    }

    async function startScanner() {
      if (isRunning) return;
      if (!window.Html5Qrcode) {
        setStatus("Scanner library failed to load.");
        sendFeedback("scanner_error", "library-load-failed");
        return;
      }

      let devices;
      try {
        devices = await Html5Qrcode.getCameras();
      } catch (err) {
        setStatus("Camera access denied. Allow permission and reload.");
        sendFeedback("scanner_error", "camera-access-denied", { error: String(err) }, true);
        return;
      }
      if (!devices || devices.length === 0) {
        setStatus("No camera found on this device.");
        sendFeedback("scanner_error", "no-camera-found");
        return;
      }

      const rearCam = devices.find(d => (d.label || "").toLowerCase().includes("back")) || devices[0];
      const supported = window.Html5QrcodeSupportedFormats || {};
      const formats = [
        supported.CODE_128,
        supported.EAN_13,
        supported.EAN_8,
        supported.UPC_A,
        supported.UPC_E
      ].filter(Boolean);

      scanner = new Html5Qrcode(scannerId, formats.length ? { formatsToSupport: formats } : {});

      try {
        await scanner.start(
          { deviceId: { exact: rearCam.id } },
          { fps: 10, qrbox: { width: 300, height: 100 } },
          handleDetected,
          () => {}
        );
      } catch (err) {
        try {
          await scanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 300, height: 100 } },
            handleDetected,
            () => {}
          );
        } catch (err2) {
          setStatus("Scanner failed to start.");
          sendFeedback("scanner_error", "start-failed", { error: String(err2) }, true);
          return;
        }
      }

      isRunning = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      setStatus("Camera scanner is running.");
      sendFeedback("scanner_started", "camera-started", { manual_mode: manualMode.checked, user_agent: navigator.userAgent });
      setTimeout(() => { trySetupZoom(); }, 700);

      clearTimeout(noDetectTimer);
      noDetectTimer = setTimeout(() => {
        if (!isRunning) return;
        if (lastScannedAt > 0) return;
        setStatus("No barcode detected yet. Try better light and distance.");
        sendFeedback("no_detection", "no-barcode-detected-10s", {}, true);
      }, 10000);
    }

    async function stopScanner() {
      if (!scanner || !isRunning) return;
      try {
        await scanner.stop();
        await scanner.clear();
      } catch (err) {}
      scanner = null;
      isRunning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus("Camera scanner is off.");
      clearTimeout(noDetectTimer);
      resetZoomUi();
      sendFeedback("scanner_stopped", "camera-stopped");
    }

    startBtn.addEventListener("click", startScanner);
    stopBtn.addEventListener("click", stopScanner);
    zoomSlider.addEventListener("input", (e) => applyZoom(e.target.value));
    manualMode.addEventListener("change", applyModeState);
    document.getElementById("scannerBox").addEventListener("click", (e) => {
      const box = e.currentTarget;
      let dot = document.getElementById("focusDot");
      if (!dot) {
        dot = document.createElement("div");
        dot.id = "focusDot";
        box.appendChild(dot);
      }
      const rect = box.getBoundingClientRect();
      dot.style.left = `${e.clientX - rect.left}px`;
      dot.style.top = `${e.clientY - rect.top}px`;
      dot.style.display = "block";
      setTimeout(() => { dot.style.display = "none"; }, 600);
      sendFeedback("focus_tap", "user-tapped-focus", { x: Math.round(e.clientX - rect.left), y: Math.round(e.clientY - rect.top) });
    });
    window.addEventListener("beforeunload", () => {
      sendFeedbackBeacon("scan_page_close", "scan-page-close", { scanner_running: isRunning });
      if (scanner && isRunning) scanner.stop().catch(() => {});
    });

    sendFeedback("scan_page_open", "scan-page-open", { manual_mode: manualMode.checked });
    pageHeartbeatTimer = setInterval(() => {
      sendFeedback("scan_page_heartbeat", "scan-page-heartbeat", { scanner_running: isRunning });
    }, 30000);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        sendFeedbackBeacon("scan_page_close", "scan-page-hidden", { scanner_running: isRunning });
      } else if (document.visibilityState === "visible") {
        sendFeedback("scan_page_open", "scan-page-visible", { scanner_running: isRunning });
      }
    });

    applyModeState();
  })();
</script>
{% endif %}
{% endblock %}
