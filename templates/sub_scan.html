{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Scan: {{ assignment['audit_name'] }} / {{ assignment['outlet'] }} / {{ assignment['department'] }}</h4>
  <a class="btn btn-outline-primary" href="{{ url_for('sub_assignments') }}">Back</a>
</div>
{% if not assignment['is_frozen'] and assignment['status'] != 'ended' %}
<div class="card p-3 mb-3">
  <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
    <button id="startCameraBtn" type="button" class="btn btn-outline-primary btn-sm">Start Camera Scanner</button>
    <button id="stopCameraBtn" type="button" class="btn btn-outline-secondary btn-sm" disabled>Stop</button>
    <span id="scannerStatus" class="small-muted">Camera scanner is off.</span>
  </div>
  <div id="scannerBox" class="border rounded" style="max-width: 540px; min-height: 280px;"></div>
  <div class="small-muted mt-2">Keep barcode centered and steady. Scanner fills barcode automatically.</div>
</div>
{% endif %}
<div class="card p-3 mb-3">
  <form method="post" class="row g-2">
    <div class="col-md-5">
      <input id="barcodeInput" class="form-control" name="barcode" placeholder="Scan or enter barcode" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %} required>
    </div>
    <div class="col-md-2">
      <input class="form-control" type="number" min="1" name="qty" value="1" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>
    </div>
    <div class="col-md-2 d-flex align-items-center">
      <input type="checkbox" class="form-check-input me-2" name="manual_entry" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>
      <label class="form-check-label">Manual</label>
    </div>
    <div class="col-md-3">
      <button class="btn btn-success w-100" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>Save Scan</button>
    </div>
  </form>
</div>
<div class="card p-3 mb-3">
  <form method="post" action="{{ url_for('sub_freeze', assignment_id=assignment['id']) }}">
    <button class="btn btn-warning" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>Freeze Department Audit</button>
  </form>
  <div class="small-muted mt-2">Once frozen, only admin can unfreeze.</div>
</div>
<div class="card p-3">
  <table class="table table-sm">
    <thead><tr><th>Barcode</th><th>Article</th><th>Scanned</th></tr></thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r['barcode'] }}</td>
        <td>{{ r['article_name'] }}</td>
        <td>{{ r['scanned_qty'] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% if not assignment['is_frozen'] and assignment['status'] != 'ended' %}
<style>
  #scannerBox video {
    width: 100% !important;
    max-height: 280px !important;
    object-fit: cover;
    border-radius: 8px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
  (() => {
    const barcodeInput = document.getElementById("barcodeInput");
    const startBtn = document.getElementById("startCameraBtn");
    const stopBtn = document.getElementById("stopCameraBtn");
    const statusEl = document.getElementById("scannerStatus");
    const scannerId = "scannerBox";
    let scanner = null;
    let isRunning = false;
    let lastScanned = "";
    let lastScannedAt = 0;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 1000;
        gain.gain.value = 0.05;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(() => {
          osc.stop();
          ctx.close();
        }, 80);
      } catch (err) {}
      if (navigator.vibrate) navigator.vibrate(80);
    }

    async function getRearCameraId() {
      if (!window.Html5Qrcode) {
        setStatus("Scanner library failed to load.");
        return null;
      }
      let cameras = [];
      try {
        cameras = await Html5Qrcode.getCameras();
      } catch (err) {
        setStatus("Camera access denied. Allow permission and reload.");
        return null;
      }
      if (!cameras || cameras.length === 0) {
        setStatus("No camera found on this device.");
        return null;
      }
      const rearCam =
        cameras.find((d) => (d.label || "").toLowerCase().includes("back")) ||
        cameras[0];
      return rearCam.id;
    }

    async function startScanner() {
      if (isRunning) return;
      const selectedId = await getRearCameraId();
      if (!selectedId) return;
      const supported = window.Html5QrcodeSupportedFormats || {};
      const formats = [
        supported.CODE_128,
        supported.EAN_13,
        supported.EAN_8,
        supported.UPC_A,
        supported.UPC_E
      ].filter((x) => x !== undefined);

      scanner = new Html5Qrcode(scannerId, formats.length ? { formatsToSupport: formats } : {});

      try {
        await scanner.start(
          { deviceId: { exact: selectedId } },
          {
            fps: 12,
            qrbox: { width: 300, height: 100 },
            disableFlip: true,
            showTorchButtonIfSupported: true,
            showZoomSliderIfSupported: true
          },
          (decodedText) => {
            const text = (decodedText || "").trim();
            const now = Date.now();
            if (!text) return;
            if (text === lastScanned && now - lastScannedAt < 1500) return;
            lastScanned = text;
            lastScannedAt = now;
            barcodeInput.value = text;
            beep();
            setStatus("Barcode captured. Tap Save Scan.");
            barcodeInput.focus();
          },
          () => {}
        );
      } catch (err) {
        setStatus("Scanner failed to start on selected camera.");
        return;
      }

      isRunning = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      setStatus("Camera scanner is running.");
    }

    async function stopScanner() {
      if (!scanner || !isRunning) return;
      try {
        await scanner.stop();
        await scanner.clear();
      } catch (err) {}
      isRunning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus("Camera scanner is off.");
    }

    startBtn.addEventListener("click", startScanner);
    stopBtn.addEventListener("click", stopScanner);
    window.addEventListener("beforeunload", () => {
      if (scanner && isRunning) scanner.stop().catch(() => {});
    });
  })();
</script>
{% endif %}
{% endblock %}
