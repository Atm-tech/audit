{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Scan: {{ assignment['audit_name'] }} / {{ assignment['outlet'] }} / {{ assignment['department'] }}</h4>
  <a class="btn btn-outline-primary" href="{{ url_for('sub_assignments') }}">Back</a>
</div>
{% if not assignment['is_frozen'] and assignment['status'] != 'ended' %}
<div class="card p-3 mb-3">
  <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
    <button id="startCameraBtn" type="button" class="btn btn-outline-primary btn-sm">Start Camera Scanner</button>
    <button id="stopCameraBtn" type="button" class="btn btn-outline-secondary btn-sm" disabled>Stop</button>
    <span id="scannerStatus" class="small-muted">Camera scanner is off.</span>
  </div>
  <div id="scannerBox" class="border rounded" style="max-width: 540px; min-height: 280px;"></div>
  <div class="small-muted mt-2">Keep barcode centered and steady. Scanner fills barcode automatically.</div>
</div>
{% endif %}
<div class="card p-3 mb-3">
  <form id="scanForm" method="post" class="row g-2">
    <div class="col-md-5">
      <input id="barcodeInput" class="form-control" name="barcode" placeholder="Scan or enter barcode" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %} required>
    </div>
    <div class="col-md-2">
      <input id="qtyInput" class="form-control" type="number" min="1" name="qty" value="1" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>
    </div>
    <div class="col-md-2 d-flex align-items-center">
      <input id="manualMode" type="checkbox" class="form-check-input me-2" name="manual_entry" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>
      <label class="form-check-label">Manual Mode</label>
    </div>
    <div class="col-md-3">
      <button class="btn btn-success w-100" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>Save Scan</button>
    </div>
  </form>
</div>
<div class="card p-3 mb-3">
  <form method="post" action="{{ url_for('sub_freeze', assignment_id=assignment['id']) }}">
    <button class="btn btn-warning" {% if assignment['is_frozen'] or assignment['status']=='ended' %}disabled{% endif %}>Freeze Department Audit</button>
  </form>
  <div class="small-muted mt-2">Once frozen, only admin can unfreeze.</div>
</div>
<div class="card p-3">
  <table class="table table-sm">
    <thead><tr><th>Barcode</th><th>Article</th><th>Scanned</th></tr></thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r['barcode'] }}</td>
        <td>{{ r['article_name'] }}</td>
        <td>{{ r['scanned_qty'] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% if not assignment['is_frozen'] and assignment['status'] != 'ended' %}
<style>
  #scannerBox video {
    width: 100% !important;
    max-height: 320px !important;
    object-fit: cover;
    border-radius: 8px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.7.7/dist/quagga.min.js"></script>
<script>
  (() => {
    const scanForm = document.getElementById("scanForm");
    const barcodeInput = document.getElementById("barcodeInput");
    const qtyInput = document.getElementById("qtyInput");
    const manualMode = document.getElementById("manualMode");
    const startBtn = document.getElementById("startCameraBtn");
    const stopBtn = document.getElementById("stopCameraBtn");
    const statusEl = document.getElementById("scannerStatus");
    const scannerId = "scannerBox";
    let scanner = null; // html5-qrcode instance
    let quaggaActive = false;
    let isRunning = false;
    let lastScanned = "";
    let lastScannedAt = 0;
    let startEpoch = 0;
    let submitInFlight = false;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 1000;
        gain.gain.value = 0.05;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(() => {
          osc.stop();
          ctx.close();
        }, 80);
      } catch (err) {}
      if (navigator.vibrate) navigator.vibrate(80);
    }

    function handleDetectedText(decodedText) {
      const text = (decodedText || "").trim();
      const now = Date.now();
      if (!text) return;
      if (text === lastScanned && now - lastScannedAt < 2000) return;
      lastScanned = text;
      lastScannedAt = now;
      if (manualMode.checked) {
        barcodeInput.value = text;
        beep();
        setStatus("Barcode captured (manual mode). Edit qty and tap Save Scan.");
        barcodeInput.focus();
      } else {
        submitAutoScan(text);
      }
    }

    function updateScannedCountInTable(barcode, delta) {
      const rows = document.querySelectorAll("table tbody tr");
      rows.forEach((row) => {
        const tds = row.querySelectorAll("td");
        if (tds.length < 3) return;
        const code = (tds[0].textContent || "").trim();
        if (code === barcode) {
          const current = parseInt((tds[2].textContent || "0").trim(), 10) || 0;
          tds[2].textContent = String(current + delta);
        }
      });
    }

    async function submitAutoScan(barcode) {
      if (submitInFlight) return;
      submitInFlight = true;
      try {
        const body = new URLSearchParams();
        body.set("barcode", barcode);
        body.set("qty", "1");
        const resp = await fetch(window.location.pathname, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body.toString()
        });
        if (!resp.ok) {
          setStatus("Auto scan failed. Check barcode list.");
          return;
        }
        beep();
        updateScannedCountInTable(barcode, 1);
        setStatus(`Scanned ${barcode} (+1)`);
      } catch (err) {
        setStatus("Auto scan failed. Network/server error.");
      } finally {
        submitInFlight = false;
      }
    }

    function applyModeState() {
      if (manualMode.checked) {
        qtyInput.disabled = false;
        setStatus("Manual mode on. Scanner fills textbox.");
      } else {
        qtyInput.value = "1";
        qtyInput.disabled = true;
        setStatus("Auto mode on. Each scan saves +1.");
      }
    }

    async function getRearCameraId() {
      if (!window.Html5Qrcode) {
        setStatus("Scanner library failed to load.");
        return null;
      }
      let cameras = [];
      try {
        cameras = await Html5Qrcode.getCameras();
      } catch (err) {
        setStatus("Camera access denied. Allow permission and reload.");
        return null;
      }
      if (!cameras || cameras.length === 0) {
        setStatus("No camera found on this device.");
        return null;
      }
      const rearCam =
        cameras.find((d) => (d.label || "").toLowerCase().includes("back")) ||
        cameras[0];
      return rearCam.id;
    }

    async function startScanner() {
      if (isRunning) return;
      const selectedId = await getRearCameraId();
      if (!selectedId) return;
      scanner = new Html5Qrcode(scannerId);
      startEpoch = Date.now();

      const onDetected = (decodedText) => handleDetectedText(decodedText);

      try {
        // Match incentive-app style: fixed fps and narrow scan strip.
        await scanner.start(
          { deviceId: { exact: selectedId } },
          { fps: 10, qrbox: { width: 300, height: 50 } },
          onDetected,
          () => {}
        );
      } catch (err) {
        // Fallback to environment-facing if deviceId exact fails on some mobiles.
        try {
          await scanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 300, height: 50 } },
            onDetected,
            () => {}
          );
        } catch (err2) {
          // Final fallback: full frame scanning for devices where narrow qrbox fails.
          try {
            await scanner.start(
              { facingMode: "environment" },
              { fps: 8 },
              onDetected,
              () => {}
            );
          } catch (err3) {
            setStatus("Scanner failed to start. Allow camera access and retry.");
            return;
          }
        }
      }

      isRunning = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      setStatus("Camera scanner is running.");

      // If nothing is detected for some time, auto-fallback to Quagga (1D barcode optimized).
      setTimeout(async () => {
        if (!isRunning) return;
        if (lastScannedAt >= startEpoch) return;
        setStatus("No detection yet. Switching to enhanced barcode mode...");
        await switchToQuagga();
      }, 7000);
    }

    async function switchToQuagga() {
      if (!window.Quagga) {
        setStatus("Enhanced scanner unavailable.");
        return;
      }
      if (!isRunning) return;

      try {
        if (scanner) {
          await scanner.stop();
          await scanner.clear();
          scanner = null;
        }
      } catch (err) {}

      const target = document.getElementById(scannerId);
      if (!target) return;
      target.innerHTML = "";

      Quagga.offDetected(onQuaggaDetected);
      Quagga.onDetected(onQuaggaDetected);

      Quagga.init(
        {
          inputStream: {
            type: "LiveStream",
            target: target,
            constraints: {
              facingMode: "environment"
            }
          },
          locator: { patchSize: "medium", halfSample: true },
          decoder: {
            readers: [
              "ean_reader",
              "ean_8_reader",
              "upc_reader",
              "upc_e_reader",
              "code_128_reader",
              "code_39_reader",
              "codabar_reader",
              "i2of5_reader"
            ]
          },
          locate: true
        },
        (err) => {
          if (err) {
            setStatus("Enhanced scanner failed to start.");
            return;
          }
          quaggaActive = true;
          Quagga.start();
          setStatus("Enhanced barcode mode is running.");
        }
      );
    }

    function onQuaggaDetected(result) {
      const code = result && result.codeResult ? result.codeResult.code : "";
      handleDetectedText(code);
    }

    async function stopScanner() {
      if (!isRunning) return;
      try {
        if (scanner) {
          await scanner.stop();
          await scanner.clear();
          scanner = null;
        }
      } catch (err) {}
      try {
        if (window.Quagga && quaggaActive) {
          Quagga.offDetected(onQuaggaDetected);
          Quagga.stop();
          quaggaActive = false;
        }
      } catch (err) {}
      isRunning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus("Camera scanner is off.");
    }

    startBtn.addEventListener("click", startScanner);
    stopBtn.addEventListener("click", stopScanner);
    manualMode.addEventListener("change", applyModeState);
    window.addEventListener("beforeunload", () => {
      if (scanner && isRunning) scanner.stop().catch(() => {});
    });
    applyModeState();
  })();
</script>
{% endif %}
{% endblock %}
