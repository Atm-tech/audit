{% extends 'base.html' %}
{% block content %}
<h4 class="mb-3">My Department Assignments</h4>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Departments Assigned</div><div class="h4 mb-0">{{ overview['departments_total'] }}</div></div></div>
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Departments Scanned</div><div class="h4 mb-0">{{ overview['departments_scanned'] }}</div></div></div>
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Departments Completed</div><div class="h4 mb-0">{{ overview['departments_completed'] }}</div></div></div>
  <div class="col-md-3"><div class="card p-3"><div class="small text-muted">Overall Efficiency</div><div class="h4 mb-0 text-{{ overview['efficiency_class'] }}">{{ overview['efficiency_score'] }}</div></div></div>
</div>

<div class="card p-3 mb-3">
  <div class="row g-3 align-items-center">
    <div class="col-md-3">
      <div class="small text-muted">Expected Qty</div>
      <div class="h5 mb-0">{{ overview['expected_total'] }}</div>
    </div>
    <div class="col-md-3">
      <div class="small text-muted">Scanned Qty</div>
      <div class="h5 mb-0">{{ overview['scanned_total'] }}</div>
    </div>
    <div class="col-md-3">
      <div class="small text-muted">Scan Entries</div>
      <div class="h5 mb-0">{{ overview['scans_count'] }}</div>
    </div>
    <div class="col-md-3">
      <div class="small text-muted">Unique Barcodes</div>
      <div class="h5 mb-0">{{ overview['unique_barcodes'] }}</div>
    </div>
  </div>
  <hr>
  <div class="small text-muted mb-1">Department Completion ({{ overview['dept_completion_pct'] }}%)</div>
  <div class="progress mb-3" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ overview['dept_completion_pct'] }}">
    <div class="progress-bar bg-info" style="width: {{ overview['dept_completion_pct'] }}%"></div>
  </div>
  <div class="small text-muted mb-1">Quantity Completion ({{ overview['qty_completion_pct'] }}%)</div>
  <div class="progress mb-3" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ overview['qty_completion_pct'] }}">
    <div class="progress-bar bg-success" style="width: {{ overview['qty_completion_pct'] if overview['qty_completion_pct'] <= 100 else 100 }}%"></div>
  </div>
  <div class="small text-muted mb-1">Scan Coverage ({{ overview['scan_coverage_pct'] }}%)</div>
  <div class="progress mb-0" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ overview['scan_coverage_pct'] }}">
    <div class="progress-bar bg-warning" style="width: {{ overview['scan_coverage_pct'] }}%"></div>
  </div>
</div>

<div class="card p-3">
  <table class="table">
    <thead><tr><th>Audit</th><th>Outlet</th><th>Department</th><th>Status</th><th>My Scan Progress</th><th>Efficiency</th><th></th></tr></thead>
    <tbody>
      {% for a in assignments %}
      <tr>
        <td>{{ a['audit_name'] }}</td>
        <td>{{ a['outlet'] if a['outlet'] else a['tag_outlet'] }}</td>
        <td>{{ a['department'] }}</td>
        <td>
          {% if a['status'] == 'ended' %}
            Audit Ended
          {% elif a['is_frozen'] %}
            Frozen
          {% else %}
            Active
          {% endif %}
        </td>
        <td style="min-width: 220px;">
          <div class="small-muted mb-1">{{ a['scanned_total'] }} / {{ a['expected_total'] }} ({{ a['raw_progress_pct'] }}%)</div>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ a['progress_pct'] }}">
            <div class="progress-bar {% if a['progress_pct'] >= 100 %}bg-success{% elif a['progress_pct'] > 0 %}bg-warning{% else %}bg-secondary{% endif %}" style="width: {{ a['progress_pct'] }}%"></div>
          </div>
        </td>
        <td>
          <span class="badge text-bg-{{ a['efficiency_class'] }}">{{ a['efficiency_score'] }}</span>
        </td>
        <td>
          {% if a['is_frozen'] or a['status'] == 'ended' %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('sub_scan', assignment_id=a['id']) }}">View Analytics</a>
          {% else %}
          <a class="btn btn-sm btn-primary" href="{{ url_for('sub_scan', assignment_id=a['id']) }}">Open Scan</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
